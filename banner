#!/bin/bash

### banner
#
### Banner with color ###
# by rern
#

width=$( tput cols ) # terminal width
hr=$( printf "\e[36m%*s\e[0m\n" "${COLUMNS:-$width}" '' | tr ' ' '-' )
info="\e[38;5;0m\e[48;5;3m i \e[0m"

usage() {
	example
	echo "example:  banner -c 6 'banner|script'"
	echo -e "
$hr
usage  :  banner [OPTION]... 'STRING'
$hr

OPTION:
--color   display color chart
-b N      background color code
-c N      character color code
-f FILE   save to file            (to be used as 'cat file')
-m        used as 'motd'          (in terminal login screen)
-r        restore original 'motd'

STRING    a-z (lowercase) : will be converted to uppercase
          ' (single quote): must be escaped and place outside quotes
          | (pipe)        : manual line break position
$hr
	"
	exit
}

# functions
################################################################################
# 
banner='' # banner lines placeholder
array2banner() {
	local string="${@^^}" # convert to uppercase
	for (( i=0; i < ${#string}; i++ )); do
		# array element to character
		char=${string:i:1}
		# character to substitue - numbers and symbols to use as variable names
		case "$char" in
			[1-9]) char="n$char";;
			0) char='O';;
			' ') char='space';;
			'.') char='dot';;
			':') char='colon';;
			',') char='comma';;
			';') char='semicolon';;
			"'") char='quote';;
			'"') char='doublequote';;
			'+') char='plus';;
			'-') char='dash';;
			'*') char='asterisk';;
			'/') char='slash';;
			'^') char='power';;
			'=') char='equal';;
			'<') char='less';;
			'>') char='more';;
			'%') char='percent';;
			'!') char='exclaim';;
			'@') char='at';;
			'#') char='hash';;
			'$') char='dollar';;
			'&') char='ampersand';;
			'_') char='underscore';;
			'\') char='backslash';;
			'{') char='curlL';;
			'[') char='bracketL';;
			'(') char='parenthesesL';;
			')') char='parenthesesR';;
			']') char='bracketR';;
			'}') char='curlR';;
			'?') char='question';;
			[^A-Z,a-z]) char='space';;
		esac
		# character / substitute to array of lines - name of each line of each character
		# A -> ar0[i]=(A[0]); ar1[i]=(A[1]) ...
		arrayline0[i]=${char}[0]
		arrayline1[i]=${char}[1]
		arrayline2[i]=${char}[2]
		arrayline3[i]=${char}[3]
		arrayline4[i]=${char}[4]
	done

	# array of lines to lines of value sequence - with '!'indirect reference
	# arrayline0=(A[0] B[0] C[0] ...) -> line0="$A[0] $B[0] $C[0] ... "
	local line0='' line1='' line2='' line3='' line4=''
	for (( i=0; i < ${#string}; i++ )); do
		line0=$line0" ${!arrayline0[i]}"
		line1=$line1" ${!arrayline1[i]}"
		line2=$line2" ${!arrayline2[i]}"
		line3=$line3" ${!arrayline3[i]}"
		line4=$line4" ${!arrayline4[i]}"
	done
	# banner - append all lines
	banner=$banner"\n$line0\n$line1\n$line2\n$line3\n$line4\n"
}
# break string to array of each banner line
string2array() {
	local string="$@"
	bannerwidth=$(( width / 6 )) # banner characters per line

	if expr index "$string" '|' &> /dev/null; then
		# manual - split string by '|' line break markers
		IFS='|' read -ra arraymanual <<< "$string"
		
		# convert array back to string with '|' markers
		string=''
		for (( j=0; j < ${#arraymanual[*]}; j++ )); do
			if [[ ${#arraymanual[j]} -le $bannerwidth ]]; then
				string="$string|${arraymanual[j]}"
			else
				# split strings in array if longer than banner line
				substring=$( echo "${arraymanual[j]}" | sed "s/.\{$bannerwidth\}/&|/g" )
				string="$string|${substring[@]}"
			fi
		done
		string=${string/|/}       # trim left '|'
	else
		# auto - insert '|' line break markers
		string=$( echo "$string" | sed "s/.\{$bannerwidth\}/&|/g" )
	fi
	
	# split string by '|' markers
	IFS='|' read -ra arraystring <<< "$string" # split
	
	# loop each banner line
	for (( j=0; j < ${#arraystring[*]}; j++ )); do # 'j' keep separation from 'i' loop
		arrayline0=(); arrayline1=(); arrayline2=(); arrayline3=(); arrayline4=()     # empty subline arrays
		substring=$( echo "${arraystring[j]}" | sed -e 's/^ //' -e 's/ $//' ) # remove leading / trailing space
		array2banner "$substring"
	done
}

# for usage function
example() {
	string2array 'banner|script'
	echo -e "\e[1m\e[36m$banner\e[0m"
}

colorchart() {
	echo
		for i in {0..255}; do
			code=$( printf %03d $i )
			printf "\e[48;5;${i}m  \e[0m \e[38;5;${i}m$code\e[0m  "
			(( i == 7 )) || (( i == 243 )) || (( i == 255 )) && echo
			( (( i == 15 )) || (( i > 15 )) && (( i < 232 )) && (( (i-15) % 6 == 0 )) ) && echo
		done
	echo
}

# options
################################################################################
bg=0
color=7
file=''
motd=''
character=''
while :; do
	case $1 in
		--color) colorchart
			exit;;
		-b) bg=$2
			shift;;
		-c) color=$2
			shift;;
		-f) file=$2
			shift;;
		-m) motd=1;;
		-r) if [[ ! -f /etc/motd.banner ]]; then
				echo -e "\n$info No custom 'motd' banner found.\n"
				exit
			fi
			rm -f /etc/motd.banner
			rm -f /etc/profile.d/motd.sh
			sed -i '\|cat /etc/banner|d' /etc/profile
			[[ -e /etc/motd.original ]] && mv /etc/motd{.original,}
			cat /etc/motd
			echo -e "$info Relogin to see this original 'mtod'.\n"
			exit;;
		-t) character=$2
			shift;;
		-h|-\?|--help) ;;
		-?*) echo -e "\n$info Unknown option: $1";;
		*) break
	esac
	shift
done

# variables - font matrix
################################################################################
# ABCDEFGHIJKLMNOPQRSTUVWXYZ 1234567890.:,;"+-*/^=<>%!@#$&_\{[()]}?'

A=(
'  #  '
' # # '
'#   #'
'#####'
'#   #'
)
B=(
'#### '
'#   #'
'#### '
'#   #'
'#### '
)
C=(
' ### '
'#   #'
'#    '
'#   #'
' ### '
)
D=(
'#### '
'#   #'
'#   #'
'#   #'
'#### '
)
E=(
'#####'
'#    '
'###  '
'#    '
'#####'
)
F=(
'#####'
'#    '
'###  '
'#    '
'#    '
)
G=(
' ####'
'#    '
'#  ##'
'#   #'
' ####'
)
H=(
'#   #'
'#   #'
'#####'
'#   #'
'#   #'
)
I=(
' # '
' # '
' # '
' # '
' # '
)
J=(
'   #'
'   #'
'   #'
'#  #'
' ## '
)
K=(
'#   #'
'#  # '
'###  '
'#  # '
'#   #'
)
L=(
'#    '
'#    '
'#    '
'#    '
'#####'
)
M=(
'#   #'
'## ##'
'# # #'
'#   #'
'#   #'
)
N=(
'#   #'
'##  #'
'# # #'
'#  ##'
'#   #'
)
O=(
' ### '
'#   #'
'#   #'
'#   #'
' ### '
)
P=(
'#### '
'#   #'
'#### '
'#    '
'#    '
)
Q=(
' ### '
'#   #'
'# # #'
'#  # '
' ## #'
)
R=(
'#### '
'#   #'
'#### '
'#  # '
'#   #'
)
S=(
' ####'
'#    '
' ### '
'    #'
'#### '
)
T=(
'#####'
'  #  '
'  #  '
'  #  '
'  #  '
)
U=(
'#   #'
'#   #'
'#   #'
'#   #'
' ### '
)
V=(
'#   #'
'#   #'
'#   #'
' # # '
'  #  '
)
W=(
'#   #'
'#   #'
'# # #'
'## ##'
'#   #'
)
X=(
'#   #'
' # # '
'  #  '
' # # '
'#   #'
)
Y=(
'#   #'
' # # '
'  #  '
'  #  '
'  #  '
)
Z=(
'#####'
'   # '
'  #  '
' #   '
'#####'
)
n1=(
'  #  '
' ##  '
'  #  '
'  #  '
' ### '
)
n2=(
' ### '
'#   #'
'   # '
' #   '
'#####'
)
n3=(
' ### '
'#   #'
'   # '
'#   #'
' ### '
)
n4=(
'   # '
'  ## '
' # # '
'#####'
'   # '
)
n5=(
'#### '
'#    '
'#### '
'    #'
'#### '
)
n6=(
' ### '
'#    '
'#####'
'#   #'
' ### '
)
n7=(
'#####'
'   # '
'  #  '
' #   '
' #   '
)
n8=(
' ### '
'#   #'
' ### '
'#   #'
' ### '
)
n9=(
' ### '
'#   #'
' ####'
'    #'
' ### '
)
space=(
'     '
'     '
'     '
'     '
'     '
)
dot=(
'     '
'     '
'     '
' ##  '
' ##  '
)
colon=(
' ##  '
' ##  '
'     '
' ##  '
' ##  '
)
comma=(
'     '
'     '
'     '
' ##  '
'  #  '
)
semicolon=(
' ##  '
' ##  '
'     '
' ##  '
'  #  '
)
doublequote=(
' # # '
' # # '
'     '
'     '
'     '
)
plus=(
'     '
'  #  '
'#####'
'  #  '
'     '
)
dash=(
'     '
'     '
'#####'
'     '
'     '
)
asterisk=(
'     '
' # # '
'#####'
' # # '
'     '
)
slash=(
'    #'
'   # '
'  #  '
' #   '
'#    '
)
power=(
'  #  '
' # # '
'#   #'
'     '
'     '
)
equal=(
'     '
'#####'
'     '
'#####'
'     '
)
less=(
'    #'
'  #  '
'#    '
'  #  '
'    #'
)
more=(
'#    '
'  #  '
'    #'
'  #  '
'#    '
)
percent=(
'##  #'
'## # '
'  #  '
' # ##'
'#  ##'
)
exclaim=(
'  #  '
'  #  '
'  #  '
'     '
'  #  '
)
at=(
' ### '
'#   #'
'# ###'
'# # #'
' ####'
)
hash=(
' # # '
'#####'
' # # '
'#####'
' # # '
)
dollar=(
' ####'
'# #  '
' ### '
'  # #'
'#### '
)
ampersand=(
' ##  '
' ##  '
'# # #'
'#  # '
' ## #'
)
underscore=(
'     '
'     '
'     '
'     '
'#####'
)
backslash=(
'#    '
' #   '
'  #  '
'   # '
'    #'
)
curlL=(
'  ## '
' #   '
'##   '
' #   '
'  ## '
)
bracketL=(
' ### '
' #   '
' #   '
' #   '
' ### '
)
parenthesesL=(
'  #  '
' #   '
' #   '
' #   '
'  #  '
)
parenthesesR=(
'  #  '
'   # '
'   # '
'   # '
'  #  '
)
bracketR=(
' ### '
'   # '
'   # '
'   # '
' ### '
)
curlR=(
' ##  '
'   # '
'   ##'
'   # '
' ##  '
)
question=(
' ### '
'#   #'
'   # '
'  #  '
'  #  '
)
quote=(
'  #  '
'  #  '
'     '
'     '
'     '
)

# commands
################################################################################
string2array "$@"

# output
bannerout=$( echo "$banner" | sed -e 's/#\+/\\e[1m\\e[38;5;'$color'm\\e[48;5;'$bg'm&/g' -e 's/#\+/&\\e[0m/g' )
if [[ $character ]]; then
	bannerout=$( echo "$bannerout" | sed 's/#/'$character'/g' )
fi
echo -e "$bannerout"

# save to file
if [[ $file ]]; then
	echo -e "$bannerout" > $file
	echo -e "\n$info cat $file \e[38;5;240m# to display the banner\e[0m\n"
fi

# modify 'motd'
if [[ $motd ]]; then
	if [[ $# > 0 ]]; then
		echo -e "$bannerout" > /etc/motd.banner
		if [[ -d /etc/profile.d ]]; then
			echo -e '#!/bin/bash\ncat /etc/motd.banner' > /etc/profile.d/motd.sh
			chmod +x /etc/profile.d/motd.sh
		else
			echo 'cat /etc/motd.banner' >> /etc/profile
		fi
		mv /etc/motd{,.original}
		echo -e "$info Relogin to see new 'mtod' banner.\n"
	else
		echo -e "$info No input for new 'motd' banner."
		usage
	fi
fi

[[ $# == 0 ]] && usage
